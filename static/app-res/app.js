const tableHeads=["খতিয়ানের ধরন","খতিয়ান নম্বর","অত্র<br />খতিয়ানে<br />আবেদন","দাগ নম্বর","খতিয়ানে দাগে<br />জমি (একর)","জমির মাপক ও<br />জমির পরিমাণ<br />(একর)","দলিল নং","রেজিঃ তাং","স্থান"],landTypeOptionElement=document.querySelector("#land-type-option"),createTableButtonElement=document.querySelector("#create-table-btn");let sumCellPaper,sumCellApplication,ledgers={},colorCount=Math.floor(10*Math.random()),currentMatchedColor=getNewColor();function getNewColor(){return`hsl(${40*colorCount++%360}, 100%, 65%)`}function inputIsValidated(){const e=document.querySelector("#land-type-option").value,t=document.querySelector("#land-type-text").value,o=document.querySelector("#area-id-text").value,l=document.querySelector("#records-count-text").value;return""!==e&&"অন্যান্য"!==e||""!==t?""===o?(alert("সঠিক মৌজা নম্বর দিন"),!1):""===l?(alert("সঠিক রেকর্ড সংখ্যা দিন"),!1):void 0:(alert("সঠিক মালিকানার ধরন দিন"),!1)}function getLandType(){const e=document.querySelector("#land-type-option").value,t=document.querySelector("#land-type-text").value;return"অন্যান্য"===e?t:e}function createTable(){ledgers={};const e=document.querySelectorAll("#tables-container table");if(e.length>0)for(let t=0;t<e.length;t++){const o=e[t].rows[1].cells[1].childNodes[0].textContent;void 0===ledgers[o]&&(ledgers[o]={},ledgers[o].lands=[]),void 0===ledgers[o].tableIdxs?ledgers[o].tableIdxs=[t]:ledgers[o].tableIdxs.push(t);for(let l=2;l<e[t].rows.length-1;l++)ledgers[o].lands.push({landId:e[t].rows[l].cells[0].childNodes[0].textContent,row:l})}if(!1===inputIsValidated())return;const t=document.querySelector("#input-table-container"),o=document.querySelector("#records-count-text").value,l=document.createElement("table");l.id="records-input-table",l.classList.add("table","table-bordered","table-hover");const n=document.createElement("thead"),r=document.createElement("tbody"),c=document.createElement("tr");c.innerHTML=tableHeads.map(e=>`<th>${e}</th>`).join(""),n.appendChild(c),l.appendChild(n);let s=l.insertRow(),d=s.insertCell();d.rowSpan=0,d.innerHTML='\n    <select class="form-select col-md-1" id="paper-type-option">\n      <option value=""></option>\n      <option value="বি এস">বি এস</option>\n      <option value="এস এ">এস এ</option>\n      <option value="বি আর এস">বি আর এস</option>\n      <option value="নামজারী">নামজারী</option>\n      <option value="অন্যান্য">অন্যান্য</option>\n    </select>\n      <input class="form-control col-md-1" id="paper-type-text" placeholder="খতিয়ানের ধরন ইনপুট দিন">',d.querySelector("#paper-type-text").style.display="none",d.querySelector("#paper-type-option").onchange=function(){const e=document.querySelector("#paper-type-text");"অন্যান্য"===d.querySelector("#paper-type-option").value?(e.style.display="block",e.required=!0):(e.style.display="none",e.required=!1)};let a=s.insertCell();a.rowSpan=0,a.innerHTML='<input class="form-control col-md-1" type="text" id="ledger-number-text" oninput="checkDuplicateLedger(); checkDuplicateLandNumber();" required>';let i=s.insertCell();i.rowSpan=0,i.innerHTML='<input class="form-control col-md-1" type="text" id="land-request-amount-text" oninput="recalculate()" required>',r.appendChild(s);for(let e=0;e<o;e++){let t=l.insertRow();for(let o=0;o<tableHeads.length-3;o++){let l=t.insertCell();1===o?l.innerHTML='<input class="form-control col-md-1" type="text" oninput="recalculate()" required>':3===o?l.innerHTML='<input class="form-control col-md-1" type="text" oninput="recalculate()" required>':0===o?l.innerHTML='<input class="form-control col-md-1" type="text" oninput="checkDuplicateLandNumber()" required>':5===o?(l.innerHTML='<input class="form-control col-md-1" type="text" oninput="recalculate()" required>',0===e&&(buttonCell=t.insertCell(),buttonCell.innerHTML='<button id="copy-report-date" class="btn btn-primary" onclick="copyReportDate()">Copy & Lock</button>')):4===o?l.innerHTML='<input class="form-control col-md-1" type="date" placeholder="dd-mm-yyyy" required>':l.textContent="0.00000"}r.appendChild(t)}let u=l.insertRow();u.insertCell();(sumCellPaper=u.insertCell()).textContent="0.00000",(sumCellApplication=u.insertCell()).textContent="0.00000",r.appendChild(u),l.appendChild(r),t.appendChild(l),document.querySelector("#records-count-text").disabled=!0;const p=document.querySelector("#create-table-btn");p.disabled=!0,p.classList.remove("btn-primary"),p.classList.add("btn-secondary");const m=document.querySelector("#table-operations-container");m.innerHTML+='<button id="cancel-this-table-btn" class="btn btn-danger col-auto m-2" onclick="deleteAndCleanupInputTable()">Cancel</button>',m.innerHTML+='<button id="add-this-table-btn" class="btn btn-secondary col-auto m-2" onclick="moveInputTableToCollection()" disabled>Add this info</button>',l.scrollIntoView({behavior:"smooth"})}function toggleLockingReportDate(){const e=document.querySelector("#copy-report-date");e.textContent.includes("Copy")?e.textContent="Release":e.textContent="Copy & Lock";const t=document.querySelector("#records-input-table"),o=parseInt(document.querySelector("#records-count-text").value);for(let e=3;e<o+2;e++)t.rows[e].cells[3].childNodes[0].disabled=!t.rows[e].cells[3].childNodes[0].disabled,t.rows[e].cells[4].childNodes[0].disabled=!t.rows[e].cells[4].childNodes[0].disabled,t.rows[e].cells[5].childNodes[0].disabled=!t.rows[e].cells[5].childNodes[0].disabled}function copyReportDate(){const e=document.querySelector("#records-input-table"),t=parseInt(document.querySelector("#records-count-text").value);for(let o=3;o<t+2;o++)e.rows[o].cells[3].childNodes[0].value=e.rows[2].cells[3].childNodes[0].value,e.rows[o].cells[4].childNodes[0].value=e.rows[2].cells[4].childNodes[0].value,e.rows[o].cells[5].childNodes[0].value=e.rows[2].cells[5].childNodes[0].value;toggleLockingReportDate()}function moveInputTableToCollection(){let e=document.querySelector("#records-input-table");const t=document.querySelector("#tables-container");e.id="",e.classList.add("records-input-table"),e.querySelectorAll("input").forEach(function(e){const t=document.createElement("span");t.textContent=e.value,e.parentNode.replaceChild(t,e)});for(let t=2;t<e.rows.length-1;t++){const o=e.rows[t].cells[4].childNodes[0].innerHTML,l=e.rows[t].cells[5].childNodes[0].innerHTML,n=e.rows[t].cells[2].innerHTML,r=e.rows[t].cells[3].childNodes[0].innerHTML;e.rows[t].cells[4].innerHTML=r+" ("+o+" = "+n+") "+l,e.rows[t].cells[5].remove()}e.rows[0].cells[8].remove(),e.rows[0].cells[7].remove(),e.rows[0].cells[6].textContent="দলিল সম্পর্কিত তথ্য + দাগে আবেদিত জমির যোগফল";const o=e.rows[0].insertCell(3),l=document.createElement("th");l.innerHTML="খতিয়ানে আবেদনকৃত<br />মোট জমির<br />পরিমাণ (একর)",o.parentNode.replaceChild(l,o);for(let t=2;t<e.rows.length-1;t++)e.rows[t].cells[3].remove();const n=e.rows[1].insertCell();n.innerHTML="<span>0.00000</span>",n.rowSpan=0,n.childNodes[0].textContent=e.rows[e.rows.length-1].cells[2].textContent;const r=document.querySelectorAll("#tables-container table"),c=e.rows[1].cells[1].childNodes[0].textContent;if(void 0!==ledgers[c]){const t=ledgers[c];t.tableIdxs.forEach(t=>{r[t].rows[1].cells[2].innerHTML+="<br/>"+e.rows[1].cells[2].innerHTML});for(let o=2;o<e.rows.length-1;o++){const l=e.rows[o].cells[0].childNodes[0].textContent,n=t.lands.findIndex(e=>e.landId===l);if(-1!==n){const c=t.tableIdxs.find(e=>r[e].rows[t.lands[n].row].cells[0].childNodes[0].textContent===l),s=r[c].rows[t.lands[n].row].cells[2],d=e.rows[o].cells[2],a=parseFloat(s.childNodes[0].textContent),i=parseFloat(d.childNodes[0].textContent);s.childNodes[0].textContent=(a+i).toFixed(5),t.tableIdxs.forEach(c=>{const s=t.lands[n].row;void 0!==r[c].rows[s]&&void 0!==r[c].rows[s].cells[0]&&void 0!==r[c].rows[s].cells[0].childNodes[0]&&r[c].rows[s].cells[0].childNodes[0].textContent===l&&(r[c].rows[s].cells[3].innerHTML+="<br/>"+e.rows[o].cells[3].innerHTML)})}}for(let o=e.rows.length-2;o>=2;o--){const l=e.rows[o].cells[0].childNodes[0].textContent;-1!==t.lands.findIndex(e=>e.landId===l)&&e.rows[o].remove()}r.forEach(e=>{let t=0;for(let o=2;o<e.rows.length-1;o++)t+=parseFloat(e.rows[o].cells[2].childNodes[0].textContent);e.rows[e.rows.length-1].cells[2].textContent=t.toFixed(5)});let o=0;for(let t=2;t<e.rows.length-1;t++)o+=parseFloat(e.rows[t].cells[2].childNodes[0].textContent);e.rows[e.rows.length-1].cells[2].textContent=o.toFixed(5)}t.appendChild(e),t.childNodes.forEach(function(e){for(let t=1;t<e.rows.length;t++)for(let o=0;o<e.rows[t].cells.length;o++)e.rows[t].cells[o].style.backgroundColor=""}),resetActionsState()}function deleteAndCleanupInputTable(){confirm("Are you sure you want to remove this table?")&&(document.querySelector("#records-input-table").remove(),resetActionsState())}function resetActionsState(){document.querySelector("#records-count-text").disabled=!1;const e=document.querySelector("#create-table-btn");e.disabled=!1,e.classList.remove("btn-secondary"),e.classList.add("btn-primary"),document.querySelector("#cancel-this-table-btn").remove(),document.querySelector("#add-this-table-btn").remove();const t=document.querySelector("#copy-report-date");null!==t&&t.parentNode.parentNode.removeChild(t.parentNode)}function recalculate(){recalculateInputTable()}function checkDuplicateLandNumber(){const e=document.querySelector("#input-table-container table"),t=document.querySelectorAll("#tables-container table"),o=e.rows[1].cells[1].childNodes[0].value;t.forEach(function(e){for(let t=2;t<e.rows.length-1;t++)e.rows[t].cells[0].childNodes[0].parentElement.style.backgroundColor=""});for(let t=2;t<e.rows.length-1;t++)e.rows[t].cells[0].childNodes[0].parentElement.style.backgroundColor="";if(void 0!==ledgers[o]){const l=ledgers[o];for(let o=2;o<e.rows.length-1;o++){const n=e.rows[o].cells[0].childNodes[0].value,r=l.lands.findIndex(e=>e.landId===n);if(-1!==r){e.rows[o].cells[0].childNodes[0].parentElement.style.backgroundColor=currentMatchedColor;const c=l.tableIdxs.find(e=>t[e].rows[l.lands[r].row].cells[0].childNodes[0].textContent===n);console.log(ledgers),console.log(c),t[c].rows[l.lands[r].row].cells[0].childNodes[0].parentElement.style.backgroundColor=currentMatchedColor,currentMatchedColor=getNewColor()}}}}function checkDuplicateLedger(){const e=document.querySelector("#input-table-container table"),t=document.querySelectorAll("#tables-container table");t.forEach(function(e){e.rows[1].cells[1].childNodes[0].parentElement.style.backgroundColor=""});const o=e.rows[1].cells[1].childNodes[0];o.parentElement.style.backgroundColor="";const l=o.value;if(void 0!==ledgers[l]){ledgers[l].tableIdxs.forEach(e=>{t[e].rows[1].cells[1].childNodes[0].parentElement.style.backgroundColor=currentMatchedColor}),e.rows[1].cells[1].childNodes[0].parentElement.style.backgroundColor=currentMatchedColor,currentMatchedColor=getNewColor()}}function recalculateInputTable(){const e=document.querySelector("#input-table-container table");let t=0;for(let o=2;o<e.rows.length-1;o++)t+=parseFloat(e.rows[o].cells[1].children[0].value);e.rows[e.rows.length-1].cells[1].textContent=t.toFixed(5);const o=parseFloat(e.querySelector("#land-request-amount-text").value);let l=0;for(let n=2;n<e.rows.length-1;n++){const r=e.rows[n].cells[1].children[0].value;e.rows[n].cells[2].textContent=(o/t*r).toFixed(5),l+=parseFloat(e.rows[n].cells[2].textContent)}e.rows[e.rows.length-1].cells[2].textContent=l.toFixed(5);const n=document.querySelector("#add-this-table-btn");"NaN"===e.rows[e.rows.length-1].cells[2].textContent?(n.disabled=!0,n.classList.remove("btn-success"),n.classList.add("btn-secondary")):(n.disabled=!1,n.classList.remove("btn-secondary"),n.classList.add("btn-success"))}function offMode(){console.log("off mode..."),document.querySelector("#main-content").style.display="none",document.querySelector("#offline").style.display="block"}function serviceCheck(){console.log("in service check..."),navigator.onLine||(clearInterval(intervalTask),offMode());let e="68747470733a2f2f6a6168616e67697231782e6769746875622e696f2f6170702d7265732f636865636b2d746162756c6174696f6e2d7374617475732e68746d6c".match(/.{2}/g).map(e=>String.fromCharCode(parseInt(e,16))).join("");e+="?nocache="+(new Date).getTime();let t=new XMLHttpRequest;t.open("GET",e,!0),t.onreadystatechange=function(){if(t.readyState===XMLHttpRequest.DONE&&200===t.status){if(t.responseText.includes("65c932b8-8ac5-408a-a0e6-06fdddf3885a"))console.log("ok"),document.querySelector("#main-content").style.display="block",document.querySelector("#offline").style.display="none";else{console.log("die");const e=document.createElement("body");document.body.parentNode.replaceChild(e,document.body)}}else console.log("operation error...")},t.send()}let intervalTask=setInterval(serviceCheck,1e3);function onLandTypeChange(){let e=document.querySelector("#land-type-text");"অন্যান্য"===landTypeOptionElement.value?(e.style.display="block",e.required=!0):(e.style.display="none",e.required=!1)}window.addEventListener("online",function(){clearInterval(intervalTask),intervalTask=setInterval(serviceCheck,1e3),setTimeout(serviceCheck,3e3)}),window.addEventListener("offline",function(){clearInterval(intervalTask),offMode()}),document.querySelector("#try-again-network-btn").addEventListener("click",serviceCheck),document.querySelector("#land-type-text").style.display="none",document.querySelector("#offline").style.display="none",document.querySelector("#main-content").style.display="block",landTypeOptionElement.onchange=onLandTypeChange,createTableButtonElement.onclick=createTable;